<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Urban Pulse — My Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="flex items-center gap-2 font-bold text-xl text-emerald-700">
                <div class="h-8 w-8 rounded bg-emerald-600 text-white flex items-center justify-center text-sm">UP</div>
                Urban Pulse
            </a>
            <nav class="flex gap-4 text-sm font-medium">
                <span id="dashboard-link"></span>
                <button onclick="logout()" class="text-gray-600 hover:text-red-600">Logout</button>
            </nav>
        </div>
    </header>

    <div class="max-w-5xl mx-auto py-12 px-6">
        <h1 class="text-3xl font-bold mb-8 text-gray-900">My Profile</h1>

        <div class="grid md:grid-cols-3 gap-8">
            <!-- Profile Info -->
            <div class="col-span-2 space-y-8">
                <!-- Personal Details -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-bold mb-6 text-gray-800">Personal Details</h2>
                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="name"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 text-sm transition-shadow">
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="email" disabled
                                class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 text-sm cursor-not-allowed">
                            <p class="text-xs text-gray-400 mt-1">Email cannot be changed.</p>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">Role</label>
                            <span id="role"
                                class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 border border-gray-200 capitalize"></span>
                        </div>

                        <div class="pt-2">
                            <button type="submit"
                                class="px-6 py-2.5 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 transition-colors shadow-sm">Save
                                Changes</button>
                        </div>
                    </form>
                </div>

                <!-- Security -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-xl font-bold mb-6 text-gray-800">Security</h2>
                    <form id="password-form" class="space-y-4">
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">Current Password</label>
                            <input type="password" id="current-password" required
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 text-sm transition-shadow"
                                placeholder="••••••••">
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">New Password</label>
                            <input type="password" id="new-password" required minlength="6"
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 text-sm transition-shadow"
                                placeholder="••••••••">
                        </div>

                        <div class="pt-2">
                            <button type="submit"
                                class="px-6 py-2.5 bg-gray-800 text-white rounded-lg text-sm font-medium hover:bg-gray-900 transition-colors shadow-sm">Update
                                Password</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-200 text-center">
                    <div class="w-24 h-24 mx-auto bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-3xl font-bold mb-4 shadow-inner"
                        id="avatar-initials"></div>
                    <h3 class="font-bold text-gray-900 text-xl mb-1" id="display-name">Loading...</h3>
                    <p class="text-sm text-gray-500" id="display-email">...</p>
                </div>

                <div class="bg-gradient-to-br from-emerald-600 to-teal-700 p-8 rounded-lg shadow-lg text-white">
                    <p class="text-emerald-100 text-sm font-medium mb-1 uppercase tracking-wide">Total Impact Points</p>
                    <p class="text-5xl font-bold" id="points">0</p>
                    <p class="text-xs text-emerald-200 mt-4 opacity-80">Earn points by reporting and resolving issues!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-6 right-6 max-w-sm px-4 py-3 rounded-lg bg-white shadow-lg border text-sm hidden z-50">
    </div>

    <script>
        const token = localStorage.getItem('up_token');
        if (!token) window.location.href = '/login';

        function showToast(message, isError) {
            const el = document.getElementById('toast');
            el.textContent = message;
            el.classList.remove('hidden');
            el.className = `fixed bottom-6 right-6 max-w-sm px-4 py-3 rounded-lg bg-white shadow-lg border text-sm z-50 ${isError ? 'border-red-500 text-red-700' : 'border-emerald-500 text-emerald-700'}`;
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        function logout() {
            localStorage.removeItem('up_token');
            localStorage.removeItem('up_user');
            window.location.href = '/login';
        }

        async function loadProfile() {
            try {
                const res = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();

                // Populate form
                document.getElementById('name').value = data.name;
                document.getElementById('email').value = data.email;
                document.getElementById('role').textContent = data.role;

                // Populate sidebar
                document.getElementById('display-name').textContent = data.name;
                document.getElementById('display-email').textContent = data.email;
                document.getElementById('points').textContent = data.points || 0;
                document.getElementById('avatar-initials').textContent = data.name.charAt(0).toUpperCase();

                // Dashboard Link
                const dLink = document.getElementById('dashboard-link');
                if (data.role === 'citizen') dLink.innerHTML = '<a href="/citizen" class="text-emerald-600 hover:underline">Dashboard</a>';
                else if (data.role === 'worker') dLink.innerHTML = '<a href="/worker" class="text-blue-600 hover:underline">Dashboard</a>';
                else if (data.role === 'admin') dLink.innerHTML = '<a href="/admin" class="text-purple-600 hover:underline">Dashboard</a>';

            } catch (e) {
                showToast('Session expired. Please login again.', true);
                setTimeout(() => window.location.href = '/login', 1500);
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            try {
                const res = await fetch('/api/auth/me', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    showToast('Profile updated!', false);
                    loadProfile();
                } else {
                    showToast('Failed to update', true);
                }
            } catch (e) { showToast('Network error', true); }
        });

        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const oldPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;

            try {
                const res = await fetch('/api/auth/change-password', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ oldPassword, newPassword })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message, false);
                    e.target.reset();
                } else {
                    showToast(data.error || 'Failed to update password', true);
                }
            } catch (e) { showToast('Network error', true); }
        });

        loadProfile();
    </script>
</body>

</html>
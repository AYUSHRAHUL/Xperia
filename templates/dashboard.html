<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Urban Pulse â€” Impact Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    * {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
      <div class="max-w-7xl mx-auto flex items-center justify-between py-4 px-6">
        <a href="/" class="flex items-center gap-3">
          <div
            class="h-10 w-10 rounded-lg bg-gradient-to-br from-emerald-600 to-emerald-700 flex items-center justify-center font-bold text-white">
            UP
          </div>
          <div>
            <div class="font-bold text-lg text-gray-900">Impact Dashboard</div>
            <p class="text-xs text-gray-600">Real-time sustainability</p>
          </div>
        </a>
        <nav class="flex items-center gap-4">
          <a href="/" class="text-sm text-gray-700 hover:text-emerald-600">Home</a>
          <a href="/login"
            class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700">
            Sign In
          </a>
        </nav>
      </div>
    </header>

    <main class="flex-1">
      <div class="max-w-7xl mx-auto py-8 px-6 space-y-8">
        <!-- Page Title -->
        <div class="text-center">
          <h1 class="text-3xl font-bold mb-2 text-gray-900">Live Sustainability Impact</h1>
          <p class="text-gray-600">Real-time tracking of community improvements</p>
        </div>

        <!-- Main Stats -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <p class="text-xs text-blue-700 font-medium mb-2">Water Saved</p>
            <p class="text-3xl font-bold text-blue-600" id="d-water">â€“</p>
            <p class="text-xs text-blue-600 mt-1">liters</p>
          </div>

          <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <p class="text-xs text-green-700 font-medium mb-2">COâ‚‚ Reduced</p>
            <p class="text-3xl font-bold text-green-600" id="d-co2">â€“</p>
            <p class="text-xs text-green-600 mt-1">kg</p>
          </div>

          <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <p class="text-xs text-amber-700 font-medium mb-2">Waste Removed</p>
            <p class="text-3xl font-bold text-amber-600" id="d-waste">â€“</p>
            <p class="text-xs text-amber-600 mt-1">kg</p>
          </div>

          <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <p class="text-xs text-emerald-700 font-medium mb-2">Issues Resolved</p>
            <p class="text-3xl font-bold text-emerald-600" id="d-issues">â€“</p>
            <p class="text-xs text-emerald-600 mt-1">completed</p>
          </div>

          <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <p class="text-xs text-violet-700 font-medium mb-2">Citizens Active</p>
            <p class="text-3xl font-bold text-violet-600" id="d-participation">â€“</p>
            <p class="text-xs text-violet-600 mt-1">reporters</p>
          </div>
        </section>

        <!-- Live Map -->
        <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
              <h2 class="text-lg font-semibold text-gray-900">Live Issue Map</h2>
              <p class="text-xs text-gray-600 mt-1">Real-time reported issues across the city</p>
            </div>
            <div class="flex gap-2 text-xs">
              <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Reported</div>
              <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> In Progress
              </div>
              <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Resolved
              </div>
            </div>
          </div>
          <div id="map" class="h-96 w-full rounded-lg z-0"></div>
        </section>

        <!-- Charts -->
        <section class="grid lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <div class="mb-6">
              <h2 class="text-lg font-semibold text-gray-900">Monthly Impact Trend</h2>
              <p class="text-xs text-gray-600 mt-1">Water saved & COâ‚‚ reduced over time</p>
            </div>
            <div class="h-64">
              <canvas id="monthly-chart"></canvas>
            </div>
          </div>

          <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
            <div class="mb-6">
              <h2 class="text-lg font-semibold text-gray-900">Resolution Time by Category</h2>
              <p class="text-xs text-gray-600 mt-1">Average hours to close issues</p>
            </div>
            <div class="h-64">
              <canvas id="resolution-chart"></canvas>
            </div>
          </div>
        </section>
      </div>

      <!-- Recent Issues & Leaderboard -->
      <section class="grid lg:grid-cols-3 gap-6">
        <!-- Recent Reports -->
        <div class="lg:col-span-2 bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Reports</h2>
          <div id="recent-issues-feed" class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
            <div class="animate-pulse space-y-4">
              <div class="h-20 bg-gray-100 rounded"></div>
              <div class="h-20 bg-gray-100 rounded"></div>
              <div class="h-20 bg-gray-100 rounded"></div>
            </div>
          </div>
        </div>

        <!-- Top Contributors -->
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Contributors</h2>
          <div id="leaderboard-preview" class="space-y-3">
            <div class="animate-pulse space-y-3">
              <div class="h-12 bg-gray-100 rounded"></div>
              <div class="h-12 bg-gray-100 rounded"></div>
              <div class="h-12 bg-gray-100 rounded"></div>
            </div>
          </div>
        </div>
      </section>
  </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-12">
    <div class="max-w-7xl mx-auto py-6 px-6 text-center text-sm text-gray-500">
      Urban Pulse â€” Impact-integrated civic reporting
    </div>
  </footer>
  </div>

  <script>
    let monthlyChart, resolutionChart, map;

    async function loadDashboard() {
      try {
        const [gRes, mRes, rRes, pRes, lRes] = await Promise.all([
          fetch('/api/impact/global'),
          fetch('/api/impact/monthly'),
          fetch('/api/admin/resolution-time'),
          fetch('/api/issues/public'),
          fetch('/api/impact/leaderboard')
        ]);

        const global = await gRes.json();
        const monthly = await mRes.json();
        const resolution = await rRes.json();
        const publicIssues = await pRes.json();
        const leaderboard = await lRes.json();

        // Update Stats
        document.getElementById('d-water').textContent = Math.round(global.totalWaterSaved || 0).toLocaleString();
        document.getElementById('d-co2').textContent = Math.round(global.totalCo2Reduced || 0).toLocaleString();
        document.getElementById('d-waste').textContent = Math.round(global.totalWasteRemoved || 0).toLocaleString();
        document.getElementById('d-issues').textContent = (global.totalIssuesResolved || 0).toLocaleString();
        document.getElementById('d-participation').textContent = (global.citizenParticipationRate || 0).toLocaleString();

        // Render Charts & Map
        renderMonthlyChart(monthly);
        renderResolutionChart(resolution);
        initMap(publicIssues);
        renderRecentFeed(publicIssues);
        renderLeaderboard(leaderboard);

      } catch (e) {
        console.error('Failed to load dashboard:', e);
      }
    }

    function initMap(issues) {
      if (!map) {
        map = L.map('map').setView([20.5937, 78.9629], 5); // India center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
      }

      // Clear existing markers if any (optional, for refresh)
      // For simplicity, we just add new ones or rely on map being mostly static per load
      // Ideally we should clear layers but issues list might grow

      issues.forEach(issue => {
        if (issue.location && issue.location.lat && issue.location.lng) {
          const color = issue.status === 'REPORTED' ? 'blue' :
            issue.status === 'IN_PROGRESS' ? 'orange' :
              issue.status === 'RESOLVED' || issue.status === 'CLOSED' ? 'green' : 'gray';

          const circle = L.circleMarker([issue.location.lat, issue.location.lng], {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);

          let popupContent = `<b>${issue.title}</b><br>${issue.category}<br>${issue.status}`;
          if (issue.imageUrl) {
            popupContent += `<br><img src="${issue.imageUrl}" style="width:100px;margin-top:5px;border-radius:4px;">`;
          }
          circle.bindPopup(popupContent);
        }
      });
    }

    function renderRecentFeed(issues) {
      const container = document.getElementById('recent-issues-feed');
      if (!issues || issues.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">No recent reports</p>';
        return;
      }

      const recent = issues.slice(0, 10); // Top 10
      container.innerHTML = recent.map(issue => `
        <div class="flex gap-4 p-4 rounded-lg bg-gray-50 border border-gray-100 hover:bg-gray-100 transition-colors">
          <div class="flex-shrink-0">
            ${issue.imageUrl
          ? `<img src="${issue.imageUrl}" class="w-16 h-16 rounded-md object-cover border border-gray-200">`
          : `<div class="w-16 h-16 rounded-md bg-gray-200 flex items-center justify-center text-2xl">ðŸ“·</div>`
        }
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex justify-between items-start">
              <h3 class="text-sm font-semibold text-gray-900 truncate">${issue.title}</h3>
              <span class="text-xs px-2 py-0.5 rounded-full ${getStatusColor(issue.status)} font-medium">${issue.status}</span>
            </div>
            <p class="text-xs text-emerald-600 mt-0.5">${issue.category}</p>
            <p class="text-xs text-gray-500 mt-1 truncate">${issue.location?.address || 'Location unavailable'}</p>
            <p class="text-xs text-gray-400 mt-2">${new Date(issue.createdAt).toLocaleDateString()}</p>
          </div>
        </div>
      `).join('');
    }

    function renderLeaderboard(leaders) {
      const container = document.getElementById('leaderboard-preview');
      if (!leaders || leaders.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">No contributors yet</p>';
        return;
      }

      const top5 = leaders.slice(0, 5);
      container.innerHTML = top5.map((l, i) => `
        <div class="flex items-center justify-between p-3 rounded bg-gray-50 hover:bg-emerald-50 transition-colors">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-yellow-100 text-yellow-700' : i === 1 ? 'bg-gray-200 text-gray-700' : i === 2 ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-600'} flex items-center justify-center text-sm font-bold">
              ${i + 1}
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900 truncate max-w-[120px]">${l.name}</p>
              <p class="text-xs text-gray-500">${l.issuesReported} reports</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-sm font-bold text-emerald-600">${l.points}</p>
            <p class="text-[10px] text-gray-400">pts</p>
          </div>
        </div>
      `).join('');
    }

    function getStatusColor(status) {
      const colors = {
        'REPORTED': 'bg-blue-100 text-blue-700',
        'VERIFIED': 'bg-purple-100 text-purple-700',
        'ASSIGNED': 'bg-amber-100 text-amber-700',
        'IN_PROGRESS': 'bg-orange-100 text-orange-700',
        'RESOLVED': 'bg-green-100 text-green-700',
        'CLOSED': 'bg-gray-100 text-gray-700'
      };
      return colors[status] || 'bg-gray-100 text-gray-700';
    }

    function renderMonthlyChart(data) {
      const ctx = document.getElementById('monthly-chart');
      if (monthlyChart) monthlyChart.destroy();

      if (!data || data.length === 0) {
        ctx.parentElement.innerHTML = '<div class="h-64 flex items-center justify-center text-gray-500 text-sm">No data available</div>';
        return;
      }

      const labels = data.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`);
      const waterData = data.map(d => Math.round(d.waterSaved || 0));
      const co2Data = data.map(d => Math.round(d.co2Reduced || 0));

      monthlyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Water Saved (L)',
              data: waterData,
              borderColor: 'rgb(37, 99, 235)',
              backgroundColor: 'rgba(37, 99, 235, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'COâ‚‚ Reduced (kg)',
              data: co2Data,
              borderColor: 'rgb(5, 150, 105)',
              backgroundColor: 'rgba(5, 150, 105, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: 'rgb(75, 85, 99)', font: { size: 11 } }
            }
          },
          scales: {
            y: {
              ticks: { color: 'rgb(107, 114, 128)', font: { size: 10 } },
              grid: { color: 'rgba(229, 231, 235, 1)' }
            },
            x: {
              ticks: { color: 'rgb(107, 114, 128)', font: { size: 10 } },
              grid: { color: 'rgba(229, 231, 235, 1)' }
            }
          }
        }
      });
    }

    function renderResolutionChart(data) {
      const ctx = document.getElementById('resolution-chart');
      if (resolutionChart) resolutionChart.destroy();

      if (!data || data.length === 0) {
        ctx.parentElement.innerHTML = '<div class="h-64 flex items-center justify-center text-gray-500 text-sm">No data available</div>';
        return;
      }

      const labels = data.map(d => d.category);
      const hours = data.map(d => (d.avgResolutionHours || 0).toFixed(1));

      resolutionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Avg Resolution Time (hours)',
            data: hours,
            backgroundColor: [
              'rgba(5, 150, 105, 0.8)',
              'rgba(37, 99, 235, 0.8)',
              'rgba(139, 92, 246, 0.8)',
              'rgba(245, 158, 11, 0.8)',
              'rgba(236, 72, 153, 0.8)'
            ],
            borderColor: [
              'rgb(5, 150, 105)',
              'rgb(37, 99, 235)',
              'rgb(139, 92, 246)',
              'rgb(245, 158, 11)',
              'rgb(236, 72, 153)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: 'rgb(75, 85, 99)', font: { size: 11 } }
            }
          },
          scales: {
            y: {
              ticks: { color: 'rgb(107, 114, 128)', font: { size: 10 } },
              grid: { color: 'rgba(229, 231, 235, 1)' }
            },
            x: {
              ticks: { color: 'rgb(107, 114, 128)', font: { size: 10 } },
              grid: { color: 'rgba(229, 231, 235, 1)' }
            }
          }
        }
      });
    }

    loadDashboard();
    setInterval(loadDashboard, 30000);
  </script>
</body>

</html>